@{
    var businesses = ViewBag.Businesses as SelectList;
}

<div class="col col-md-12">

    <div class="row" style="padding-bottom:10px;">
        <div class="col-md-2">
            <label for="businessDropdown">Select Business:</label>
        </div>
        <div class="col-md-3">
            <select id="businessDropdown">
                @foreach (var item in businesses)
                {
                    <option value="@item.Value">@item.Text</option>
                }
            </select>
        </div>
    </div>
    <div class="table-responsive">
        <table id="chatGrid" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th></th>
                    <th>Sender Id</th>
                    <th>Question</th>
                    <th>Answer</th>
                    <th>Created At</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<script>
    $(document).ready(function () {
        $("#businessDropdown").select2();
        // Set the first option as selected
        $("#businessDropdown option:first").attr("selected", "selected");
        var selectedBusinessId = $("#businessDropdown").val();
        var bId = parseInt(selectedBusinessId);
        // Initialize DataTable
        var dataTable = $('#chatGrid').DataTable({
            ajax: '@Url.Action("GetBusinessChatList", "Business")' + '?businessId=52',// + bId,
            columns: [
                {
                    className: 'dt-control',
                    orderable: false,
                    data: null,
                    defaultContent: ''
                },
                { data: 'SenderId' },
                { data: 'Question' },
                { data: 'Answer' },
                { data: 'CreatedAt' }
            ]
        });

        // Handle row click event to expand/collapse subgrid
        $('#chatGrid tbody').on('click', 'td.dt-control', function () {
            debugger
            var tr = $(this).closest('tr');
            var row = dataTable.row(tr);
            var rowData = row.data();

            if (row.child.isShown()) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');

                // Destroy the Child Datatable
                $('#' + rowData.SenderId).DataTable().destroy();
            } else {
                // Open this row
                row.child(format(rowData)).show();
                loadSubgrid(tr, rowData);
            }
        });

        function format(rowData) {
            return '<table id="' + rowData.SenderId + '" cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">' +           /*rowData[0] = SenderId*/
                '<thead>' +
                '<tr>' +
                '<th>Sender Id</th>' +
                '<th>Question</th>' +
                '<th>Answer</th>' +
                '<th>Created At</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody></tbody>' +
                '</table>';
        }

        function loadSubgrid(tr, rowData) {
            var senderId = rowData.SenderId;
            $('#' + senderId).DataTable({
                ajax: '@Url.Action("GetChatsBySenderId", "Business")' + '?senderId=' + senderId,
                columns: [
                    { data: 'SenderId' },
                    { data: 'Question' },
                    { data: 'Answer' },
                    { data: 'CreatedAt' }
                ],
                paging: true,
                scrollY: '400px',
                select: true
            });

            tr.addClass('shown');
        }

        // Handle dropdown change event
        $('#businessDropdown').change(function () {
            var selectedBusinessId = $(this).val();
            if (selectedBusinessId) {
                // Make an AJAX call to load chats for the selected business
                $.ajax({
                    url: 'GetBusinessChatList',
                    type: 'GET',
                    data: { businessId: selectedBusinessId },
                    success: function (response) {
                        // Clear existing rows in DataTable
                        dataTable.clear();

                        // Extract and add new rows to DataTable
                        response.data.forEach(function (item) {
                            dataTable.row.add([
                                item.SenderId,
                                item.Question,
                                item.Answer,
                                item.CreatedAt
                            ]);
                        });

                        // Draw the DataTable
                        dataTable.draw();
                        $('#chatGrid').show();
                        $('.table-responsive').show();
                    },
                    error: function () {
                        console.error('Failed to load chats for the selected business.');
                    }
                });
            }
        });
    });
</script>